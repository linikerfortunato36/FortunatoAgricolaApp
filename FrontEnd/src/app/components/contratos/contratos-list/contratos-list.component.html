<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <h2 class="h3 fw-bold text-dark mb-1">Contratos</h2>
            <p class="text-muted mb-0 small">Visualização de contratos firmados e seu acompanhamento diário.</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success d-flex align-items-center gap-2" (click)="exportarPDF()"
                [disabled]="getContratosFiltrados().length === 0" title="Exportar lista filtrada como PDF">
                <i class="bi bi-file-earmark-pdf-fill"></i>
                <span>Exportar PDF</span>
                <span class="badge bg-success text-white ms-1">{{ getContratosFiltrados().length }}</span>
            </button>
            <button routerLink="/app/contratos/novo" class="btn btn-primary d-flex align-items-center gap-2">
                <i class="bi bi-file-earmark-plus"></i> Novo Contrato
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <!-- Barra de Filtros Intuitiva -->
            <div class="p-3 border-bottom d-flex flex-wrap gap-3 bg-light align-items-center">
                <div class="input-group" style="max-width: 250px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" [(ngModel)]="filtroNumero"
                        placeholder="Número do contrato...">
                </div>

                <div class="d-flex align-items-center gap-2">
                    <label class="text-muted small mb-0 ms-2 fw-bold">Status:</label>
                    <ng-select [items]="['Todos', 'Aberto', 'Em Andamento', 'Finalizado']" [(ngModel)]="filtroStatus"
                        [clearable]="false" style="width: 140px;" class="shadow-sm">
                    </ng-select>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <label class="text-muted small mb-0 ms-2 fw-bold">Cliente:</label>
                    <ng-select [items]="clientes" bindLabel="nome" bindValue="id" [(ngModel)]="filtroClienteId"
                        placeholder="Todos os Clientes" style="width: 220px;" class="shadow-sm">
                    </ng-select>
                </div>

                <div class="ms-auto">
                    <button class="btn btn-outline-secondary btn-sm" (click)="limparFiltros()"><i
                            class="bi bi-funnel"></i> Limpar
                        Filtros</button>
                </div>
            </div>

            <!-- Grade de Contratos -->
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light text-muted small">
                        <tr>
                            <th class="ps-4">Nº CONTRATO</th>
                            <th>CLIENTE DESTINO</th>
                            <th>TOTAL ACORDADO</th>
                            <th>TOTAL ENTREGUE</th>
                            <th style="width: 20%">STATUS / METAS</th>
                            <th>ÚLTIMA ALTERAÇÃO</th>
                            <th class="pe-4 text-end">AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody>

                        <!-- *ngFor Contrato iteration -->
                        <tr *ngFor="let c of getContratosFiltrados()">
                            <td class="ps-4 fw-bold text-dark">{{ c.numeroContrato }}</td>
                            <td>{{ c.clienteNome }}</td>
                            <td><span class="fw-bold">{{ (c.quantidadeTotalKg / 1000) | number:'1.0-0' }} t</span></td>
                            <td
                                [ngClass]="{'text-success fw-bold': c.quantidadeEntregueKg > 0, 'text-muted': c.quantidadeEntregueKg === 0}">
                                {{ (c.quantidadeEntregueKg / 1000) | number:'1.0-0' }} t
                            </td>
                            <td>
                                <div class="d-flex justify-content-between small text-primary fw-bold mb-1">
                                    <span>{{ c.status }}</span>
                                    <span>{{ getProgressoWidth(c.quantidadeEntregueKg, c.quantidadeTotalKg) |
                                        number:'1.0-0' }}%</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-primary" role="progressbar"
                                        [style.width]="getProgressoWidth(c.quantidadeEntregueKg, c.quantidadeTotalKg) + '%'"
                                        [attr.aria-valuenow]="getProgressoWidth(c.quantidadeEntregueKg, c.quantidadeTotalKg)"
                                        aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            </td>
                            <td class="small text-muted">
                                <div *ngIf="c.updatedByName">
                                    <i class="bi bi-person text-muted me-1"></i>{{ c.updatedByName }}
                                    <div class="x-small">{{ c.updatedAt | date:'dd/MM/yyyy HH:mm' }}</div>
                                </div>
                                <div *ngIf="!c.updatedByName && c.createdByName">
                                    <i class="bi bi-person text-muted me-1"></i>{{ c.createdByName }}
                                    <div class="x-small">{{ c.createdAt | date:'dd/MM/yyyy' }}</div>
                                </div>
                                <div *ngIf="!c.updatedByName && !c.createdByName">--</div>
                            </td>
                            <td class="pe-4 text-end">
                                <button [routerLink]="['/app/contratos/detalhe', c.id]"
                                    class="btn btn-sm btn-outline-primary shadow-sm"
                                    title="Ver Detalhes e Inserir Entregas">
                                    <i class="bi bi-arrow-right-short fs-6"></i> Acessar Painel
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>