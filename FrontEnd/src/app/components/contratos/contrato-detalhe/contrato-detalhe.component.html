<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a routerLink="/app/contratos"
                            class="text-decoration-none">Contratos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Painel de Acompanhamento ({{
                        contrato?.numeroContrato || '...' }})</li>
                </ol>
            </nav>
            <h2 class="h3 fw-bold text-dark mb-0">Contrato Nº {{ contrato?.numeroContrato || 'Carregando...' }}</h2>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-danger"><i class="bi bi-file-earmark-pdf me-1"></i> Exportar
                Fechamento</button>
            <button routerLink="/app/movimentacoes/novo" [queryParams]="{contratoId: contratoId}"
                class="btn btn-primary fw-bold">
                <i class="bi bi-plus-circle me-1"></i> Nova Movimentação
            </button>
        </div>
    </div>

    <!-- Cartões de Resumo do Contrato -->
    <div class="row g-4 mb-5">
        <!-- Cliente Destino -->
        <div class="col-md-3">
            <div class="card h-100 shadow-sm border-0 border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase fw-bold mb-3 small">Cliente Destino</h6>
                    <h5 class="fw-bold mb-1 text-dark">{{ contrato?.clienteNome || '—' }}</h5>
                    <p class="mb-0 small text-muted"><i class="bi bi-tag me-1"></i> Status: {{ contrato?.status || '—'
                        }}</p>
                </div>
            </div>
        </div>

        <!-- Status do Atendimento da Meta -->
        <div class="col-md-5">
            <div class="card h-100 shadow-sm border-0 bg-light">
                <div class="card-body d-flex flex-column justify-content-center pt-4">
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <div>
                            <h6 class="text-muted fw-bold mb-1 small text-uppercase">Volumetria Negociada vs Entregue
                            </h6>
                            <span class="fs-4 fw-bolder text-dark">{{ ((contrato?.quantidadeEntregueKg || 0) / 1000) |
                                number:'1.0-0' }} t</span>
                            <span class="text-muted">/ {{ ((contrato?.quantidadeTotalKg || 0) / 1000) | number:'1.0-0'
                                }} t</span>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary fs-6 px-3 rounded-pill shadow-sm">{{ getProgressoPct() |
                                number:'1.0-0' }}%</span>
                        </div>
                    </div>
                    <div class="progress" style="height: 12px; border-radius: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                            role="progressbar" [style.width]="getProgressoPct() + '%'"></div>
                    </div>
                    <p class="text-danger small mt-2 fw-bold mb-0 text-end"><i
                            class="bi bi-exclamation-triangle-fill me-1"></i> Restam {{ ((contrato?.quantidadeRestanteKg
                        || 0) / 1000) | number:'1.0-0' }} t para bater a meta</p>
                </div>
            </div>
        </div>

        <!-- Balanço Financeiro Base -->
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-primary text-white text-end">
                <div class="card-body">
                    <h6 class="text-uppercase fw-bold mb-3 small opacity-75">Valores & Entregas (Nfe)</h6>
                    <h4 class="fw-bold mb-1">R$ 5.200.000,00</h4>
                    <p class="mb-0 small opacity-75"><i class="bi bi-graph-up-arrow me-1 text-secondary"></i>
                        Faturamento Estimado (Bruto)</p>
                    <hr class="my-2 border-white opacity-25">
                    <p class="mb-0 small"><strong>1.250</strong> Caminhões / Viagens Feitas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Inserção Expressa e Movimentações (Requisito) -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom pt-4 pb-3 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold text-dark mb-0"><i class="bi bi-journal-arrow-up text-primary me-2"></i> Adicionar
                Entrega ao Contrato</h5>
            <button routerLink="/app/movimentacoes/novo" class="btn btn-sm btn-outline-primary fw-bold px-3">Modo
                Completo (Avançado)</button>
        </div>

        <div class="card-body p-0">
            <!-- Formulário Horizontal Rápido de Movimentação (inserção) -->
            <div class="bg-light p-3 border-bottom">
                <form class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-dark mb-1">Data</label>
                        <input type="date" class="form-control form-control-sm border-0 shadow-sm">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-dark mb-1">Produtor (Origem)</label>
                        <select class="form-select form-select-sm border-0 shadow-sm">
                            <option selected>Selecione a Fazenda...</option>
                            <option>Fazenda Boa Vista</option>
                            <option>Grupo Sperafico</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-dark mb-1">Transportadora</label>
                        <select class="form-select form-select-sm border-0 shadow-sm">
                            <option selected>Selecione...</option>
                            <option>TransGrãos LTDA</option>
                            <option>Expresso Safra</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-dark mb-1">Motorista/Placa</label>
                        <input type="text" class="form-control form-control-sm border-0 shadow-sm"
                            placeholder="João / ABC-1234">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-dark mb-1">Net (Liq) Fazenda (Kg)</label>
                        <input type="number"
                            class="form-control form-control-sm border-0 shadow-sm text-end text-primary fw-bold"
                            placeholder="0,00">
                    </div>
                    <div class="col-md-1 d-grid">
                        <button class="btn btn-sm btn-primary shadow-sm"><i class="bi bi-plus-lg fw-bold"></i>
                            Salvar</button>
                    </div>
                </form>
                <!-- Dropdown de Descontos Ocultos (Impurezas/Umidade) -->
                <div class="mt-2 text-end">
                    <a href="#" class="text-decoration-none small text-muted"><i class="bi bi-sliders me-1"></i>
                        Informar Umidade e Impureza / Frete Custo</a>
                </div>
            </div>

            <!-- Histórico de Carregamentos Deste Contrato -->
            <div class="p-4">
                <h6 class="fw-bold text-secondary text-uppercase mb-3 mt-1">Carregamentos (Tickets) Associados</h6>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover bg-white mb-0 align-middle text-center small">
                        <thead class="table-light text-muted">
                            <tr>
                                <th class="text-start ps-3">DATA</th>
                                <th class="text-start">PRODUTOR ORIGEM</th>
                                <th class="text-start">VEÍCULO / TRANS.</th>
                                <th>P. O. (Kg)</th>
                                <th>DESC. (Kg)</th>
                                <th title="Umidade (kg e %)">UMID.</th>
                                <th title="Impureza (kg e %)">IMPUR.</th>
                                <th class="text-primary fw-bold">P. LÍQ FINAL</th>
                                <th class="text-end pe-3">OPÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Linha vazia quando não há movimentações -->
                            <tr *ngIf="movimentacoes.length === 0">
                                <td colspan="9" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2 opacity-25"></i>
                                    Nenhuma movimentação registrada para este contrato ainda.<br>
                                    <small>Use o botão <strong>Nova Movimentação</strong> acima para registrar a
                                        primeira entrega.</small>
                                </td>
                            </tr>
                            <!-- Linhas dinâmicas da API -->
                            <tr *ngFor="let m of movimentacoes">
                                <td class="text-start ps-3 fw-bold">{{ m.data | date:'dd/MM/yyyy' }}</td>
                                <td class="text-start">{{ m.produtorOrigemNome }}</td>
                                <td class="text-start">{{ m.transportadoraNome }} {{ m.motorista ? '(' + m.motorista +
                                    ')' : '' }}</td>
                                <td>{{ m.quantidadeOrigemKg | number:'1.0-0' }}</td>
                                <td
                                    [ngClass]="m.quantidadeOrigemKg - m.pesoDescargaKg > 0 ? 'text-danger' : 'text-success'">
                                    {{ m.quantidadeOrigemKg - m.pesoDescargaKg > 0 ? '-' : '' }}{{ (m.quantidadeOrigemKg
                                    - m.pesoDescargaKg) | number:'1.0-0' }}
                                </td>
                                <td>{{ m.umidadeKg | number:'1.0-0' }} kg ({{ m.umidadePorcentagem | number:'1.1-1' }}%)
                                </td>
                                <td>{{ m.impurezaKg | number:'1.0-0' }} kg ({{ m.impurezaPorcentagem | number:'1.1-1'
                                    }}%)</td>
                                <td class="text-primary fw-bold fs-6 bg-light">{{ m.pesoFinal | number:'1.0-0' }} Kg
                                </td>
                                <td class="text-end pe-3">
                                    <button class="btn btn-sm text-secondary p-1" title="Ver detalhes">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm text-danger p-1" title="Excluir movimentação"
                                        (click)="excluirMovimentacao(m.id)">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>