<!-- HEADER -->
<div class="relatorios-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 fw-bold mb-1"><i class="bi bi-bar-chart-line me-2"></i>Central de Relat√≥rios</h1>
            <p class="mb-0 opacity-75">An√°lise financeira e operacional da Fortunato Agr√≠cola</p>
        </div>
        <div *ngIf="!loading">
            <span class="badge bg-white text-dark fs-6 px-3 py-2">
                <i class="bi bi-collection me-1 text-success"></i>
                {{ todasMovimentacoes.length }} movimenta√ß√µes no total
            </span>
        </div>
    </div>
</div>

<!-- LOADING -->
<div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-success" role="status"></div>
    <div class="mt-3 text-muted">Carregando dados...</div>
</div>

<div *ngIf="!loading">
    <!-- ABAS -->
    <div class="report-tabs">
        <button class="report-tab" [class.active]="abaAtiva === 'comissao'" (click)="abaAtiva = 'comissao'">
            <i class="bi bi-person-check"></i> Comiss√£o por Vendedor
        </button>
        <button class="report-tab" [class.active]="abaAtiva === 'custos'" (click)="abaAtiva = 'custos'">
            <i class="bi bi-receipt"></i> Custos de Frete e Armaz√©m
        </button>
        <button class="report-tab" [class.active]="abaAtiva === 'contrato'" (click)="abaAtiva = 'contrato'">
            <i class="bi bi-file-earmark-bar-graph"></i> Balan√ßo por Contrato
        </button>
        <button class="report-tab" [class.active]="abaAtiva === 'produtor'" (click)="abaAtiva = 'produtor'">
            <i class="bi bi-person-badge"></i> Balan√ßo por Produtor
        </button>
    </div>

    <!-- =============================================
       ABA 1: COMISS√ÉO POR VENDEDOR
  ============================================= -->
    <div *ngIf="abaAtiva === 'comissao'">
        <!-- Filtro M√™s -->
        <div class="filter-bar">
            <div>
                <label>M√™s de refer√™ncia</label>
                <input type="month" class="form-control" [(ngModel)]="filtroComissaoMes">
            </div>
            <div class="ms-auto text-muted small align-self-center">
                <i class="bi bi-info-circle me-1"></i>
                Exibindo {{ comissaoVendedores.length }} vendedor(es) com movimenta√ß√µes no per√≠odo
            </div>
        </div>

        <!-- KPIs -->
        <div class="kpi-row">
            <div class="kpi-card" style="--kpi-color:#16a34a">
                <div class="kpi-label">Total de Vendas</div>
                <div class="kpi-value green">{{ comissaoTotais.venda | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#c9a84c">
                <div class="kpi-label">Total de Comiss√µes</div>
                <div class="kpi-value gold">{{ comissaoTotais.comissao | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#2563eb">
                <div class="kpi-label">Sacas Movimentadas</div>
                <div class="kpi-value blue">{{ comissaoTotais.sacas | number:'1.0-1' }} sc</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#94a3b8">
                <div class="kpi-label">Movimenta√ß√µes</div>
                <div class="kpi-value">{{ comissaoTotais.movs }}</div>
            </div>
        </div>

        <!-- Tabela Comiss√£o -->
        <div class="report-card">
            <div class="report-card-header">
                <div class="report-card-title">
                    <i class="bi bi-person-check-fill"></i> Ranking de Vendedores ‚Äî {{ filtroComissaoMes | date:'MMMM
                    yyyy':'':'pt-BR' }}
                </div>
            </div>
            <div *ngIf="comissaoVendedores.length === 0" class="empty-state">
                <i class="bi bi-inbox"></i>
                Nenhuma movimenta√ß√£o encontrada para este m√™s.
            </div>
            <table *ngIf="comissaoVendedores.length > 0" class="report-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Vendedor</th>
                        <th class="text-end">Viagens</th>
                        <th class="text-end">Sacas</th>
                        <th class="text-end">Total Venda</th>
                        <th class="text-end">Comiss√£o (R$)</th>
                        <th style="width:160px">% do Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let v of comissaoVendedores; let i = index">
                        <td>
                            <span class="rank-badge"
                                [ngClass]="i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other'">
                                {{ i + 1 }}
                            </span>
                        </td>
                        <td><strong>{{ v.vendedorNome }}</strong></td>
                        <td class="text-end">{{ v.numMovimentacoes }}</td>
                        <td class="text-end">{{ v.totalSacas | number:'1.0-1' }}</td>
                        <td class="text-end">{{ v.totalVenda | currency:'BRL':'symbol':'1.2-2' }}</td>
                        <td class="text-end"><strong class="text-success">{{ v.comissaoTotal |
                                currency:'BRL':'symbol':'1.2-2' }}</strong></td>
                        <td>
                            <div class="small text-muted mb-1">{{ comissaoTotais.comissao > 0 ? ((v.comissaoTotal /
                                comissaoTotais.comissao) * 100 | number:'1.1-1') : 0 }}%</div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill"
                                    [style.width.%]="comissaoTotais.comissao > 0 ? (v.comissaoTotal / comissaoTotais.comissao) * 100 : 0">
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2">TOTAL GERAL</td>
                        <td class="text-end">{{ comissaoTotais.movs }}</td>
                        <td class="text-end">{{ comissaoTotais.sacas | number:'1.0-1' }}</td>
                        <td class="text-end">{{ comissaoTotais.venda | currency:'BRL':'symbol':'1.2-2' }}</td>
                        <td class="text-end">{{ comissaoTotais.comissao | currency:'BRL':'symbol':'1.2-2' }}</td>
                        <td>100%</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- =============================================
       ABA 2: CUSTOS FRETE E ARMAZ√âM
  ============================================= -->
    <div *ngIf="abaAtiva === 'custos'">
        <div class="filter-bar">
            <div>
                <label>M√™s de refer√™ncia</label>
                <input type="month" class="form-control" [(ngModel)]="filtroCustosMes">
            </div>
        </div>

        <!-- KPIs Custos -->
        <div class="kpi-row">
            <div class="kpi-card" style="--kpi-color:#2563eb">
                <div class="kpi-label">Total Frete</div>
                <div class="kpi-value blue">{{ custosTotais.frete | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#dc2626">
                <div class="kpi-label">Armaz√©m ‚Äî N√≥s pagamos</div>
                <div class="kpi-value red">{{ custosTotais.armazemNos | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#16a34a">
                <div class="kpi-label">Armaz√©m ‚Äî Cliente paga</div>
                <div class="kpi-value green">{{ custosTotais.armazemCliente | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#f59e0b">
                <div class="kpi-label">Custo Total (nossos)</div>
                <div class="kpi-value" style="color:#d97706">{{ custosTotais.totalCustos |
                    currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
        </div>

        <!-- Custo por Transportadora -->
        <div class="report-card">
            <div class="report-card-header">
                <div class="report-card-title"><i class="bi bi-truck"></i> Custo por Transportadora</div>
            </div>
            <div *ngIf="custosTransportadoras.length === 0" class="empty-state">
                <i class="bi bi-truck"></i> Sem dados no per√≠odo selecionado.
            </div>
            <table *ngIf="custosTransportadoras.length > 0" class="report-table">
                <thead>
                    <tr>
                        <th>Transportadora</th>
                        <th class="text-end">Viagens</th>
                        <th class="text-end">Sacas</th>
                        <th class="text-end">Total Frete</th>
                        <th class="text-end">Frete p/ Saca</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let t of custosTransportadoras">
                        <td><strong>{{ t.nome }}</strong></td>
                        <td class="text-end">{{ t.viagens }}</td>
                        <td class="text-end">{{ t.sacas | number:'1.0-1' }}</td>
                        <td class="text-end text-primary fw-bold">{{ t.frete | currency:'BRL':'symbol':'1.2-2' }}</td>
                        <td class="text-end">{{ t.sacas > 0 ? (t.frete / t.sacas | currency:'BRL':'symbol':'1.2-2') :
                            '-' }}</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td>TOTAL</td>
                        <td class="text-end">{{ custosMov.length }}</td>
                        <td class="text-end">{{ custosTotais.sacas | number:'1.0-1' }}</td>
                        <td class="text-end">{{ custosTotais.frete | currency:'BRL':'symbol':'1.2-2' }}</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Detalhe Armaz√©m -->
        <div class="report-card">
            <div class="report-card-header">
                <div class="report-card-title"><i class="bi bi-building"></i> Custos de Armaz√©m ‚Äî Quem Paga</div>
            </div>
            <div class="p-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="p-4 rounded-3 text-center" style="background:#fef2f2; border:2px solid #fecaca;">
                            <div class="fs-2 mb-2">üè¢</div>
                            <div class="fw-bold text-danger mb-1">Armaz√©m ‚Äî N√≥s pagamos</div>
                            <div class="fs-2 fw-bold text-danger">{{ custosTotais.armazemNos |
                                currency:'BRL':'symbol':'1.2-2' }}</div>
                            <div class="text-muted small mt-2">
                                Custos do per√≠odo selecionado
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-4 rounded-3 text-center" style="background:#f0fdf4; border:2px solid #bbf7d0;">
                            <div class="fs-2 mb-2">ü§ù</div>
                            <div class="fw-bold text-success mb-1">Armaz√©m ‚Äî Cliente paga</div>
                            <div class="fs-2 fw-bold text-success">{{ custosTotais.armazemCliente |
                                currency:'BRL':'symbol':'1.2-2' }}</div>
                            <div class="text-muted small mt-2">Reduz custo operacional</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =============================================
       ABA 3: BALAN√áO POR CONTRATO
  ============================================= -->
    <div *ngIf="abaAtiva === 'contrato'">
        <!-- Filtros -->
        <div class="filter-bar">
            <div>
                <label>Cliente</label>
                <select class="form-select" [(ngModel)]="filtroContratoClienteId" style="min-width:180px;">
                    <option value="">Todos os clientes</option>
                    <option *ngFor="let c of todosClientes" [value]="c.id">{{ c.nome }}</option>
                </select>
            </div>
            <div>
                <label>Contrato</label>
                <select class="form-select" [(ngModel)]="filtroContratoId" style="min-width:180px;">
                    <option value="">Todos os contratos</option>
                    <option *ngFor="let c of contratosPorCliente" [value]="c.id">{{ c.numeroContrato }}</option>
                </select>
            </div>
            <div>
                <label>Per√≠odo ‚Äî De</label>
                <input type="date" class="form-control" [(ngModel)]="filtroContratoPeriodoInicio">
            </div>
            <div>
                <label>Per√≠odo ‚Äî At√©</label>
                <input type="date" class="form-control" [(ngModel)]="filtroContratoPeriodoFim">
            </div>
            <div class="ms-auto">
                <button class="btn btn-outline-secondary btn-sm" (click)="limparFiltrosContrato()">
                    <i class="bi bi-x-circle me-1"></i> Limpar
                </button>
            </div>
        </div>

        <!-- KPIs Contrato -->
        <div class="kpi-row">
            <div class="kpi-card" style="--kpi-color:#16a34a">
                <div class="kpi-label">Total Venda</div>
                <div class="kpi-value green">{{ balancoContratosTotais.venda | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#2563eb">
                <div class="kpi-label">Total Frete</div>
                <div class="kpi-value blue">{{ balancoContratosTotais.frete | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#f59e0b">
                <div class="kpi-label">Ganho Bruto</div>
                <div class="kpi-value gold">{{ balancoContratosTotais.ganhoBruto | currency:'BRL':'symbol':'1.2-2' }}
                </div>
            </div>
            <div class="kpi-card" style="--kpi-color:#16a34a">
                <div class="kpi-label">Ganho L√≠quido</div>
                <div class="kpi-value green">{{ balancoContratosTotais.ganhoLiquido | currency:'BRL':'symbol':'1.2-2' }}
                </div>
            </div>
        </div>

        <!-- Tabela Contratos -->
        <div class="report-card">
            <div class="report-card-header">
                <div class="report-card-title"><i class="bi bi-file-earmark-bar-graph-fill"></i> Resultado por Contrato
                </div>
                <span class="badge bg-light text-dark">{{ balancoContratos.length }} contrato(s)</span>
            </div>
            <div *ngIf="balancoContratos.length === 0" class="empty-state">
                <i class="bi bi-file-earmark"></i> Nenhum resultado para os filtros aplicados.
            </div>
            <div class="table-responsive" *ngIf="balancoContratos.length > 0">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Contrato</th>
                            <th>Cliente</th>
                            <th class="text-end">Entradas</th>
                            <th class="text-end">Sacas</th>
                            <th class="text-end">Total Venda</th>
                            <th class="text-end">Total Frete</th>
                            <th class="text-end">Armaz√©m (n√≥s)</th>
                            <th class="text-end">Armaz√©m (cliente)</th>
                            <th class="text-end">Ganho Bruto</th>
                            <th class="text-end">Ganho L√≠quido</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let c of balancoContratos">
                            <td><strong class="text-primary">{{ c.contratoNumero }}</strong></td>
                            <td>{{ c.clienteNome }}</td>
                            <td class="text-end">{{ c.numMovimentacoes }}</td>
                            <td class="text-end">{{ c.totalSacas | number:'1.0-1' }}</td>
                            <td class="text-end">{{ c.totalVenda | currency:'BRL':'symbol':'1.2-2' }}</td>
                            <td class="text-end text-primary">{{ c.totalFrete | currency:'BRL':'symbol':'1.2-2' }}</td>
                            <td class="text-end text-danger">{{ c.totalNos | currency:'BRL':'symbol':'1.2-2' }}</td>
                            <td class="text-end text-success">{{ c.totalCliente | currency:'BRL':'symbol':'1.2-2' }}
                            </td>
                            <td class="text-end fw-bold">{{ c.ganhoBruto | currency:'BRL':'symbol':'1.2-2' }}</td>
                            <td class="text-end fw-bold text-success">{{ c.ganhoLiquido |
                                currency:'BRL':'symbol':'1.2-2' }}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4">TOTAL</td>
                            <td class="text-end">{{ balancoContratosTotais.venda | currency:'BRL':'symbol':'1.2-2' }}
                            </td>
                            <td class="text-end">{{ balancoContratosTotais.frete | currency:'BRL':'symbol':'1.2-2' }}
                            </td>
                            <td class="text-end">{{ balancoContratosTotais.armazem | currency:'BRL':'symbol':'1.2-2' }}
                            </td>
                            <td></td>
                            <td class="text-end">{{ balancoContratosTotais.ganhoBruto | currency:'BRL':'symbol':'1.2-2'
                                }}</td>
                            <td class="text-end text-success">{{ balancoContratosTotais.ganhoLiquido |
                                currency:'BRL':'symbol':'1.2-2' }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- =============================================
       ABA 4: BALAN√áO POR PRODUTOR
  ============================================= -->
    <div *ngIf="abaAtiva === 'produtor'">
        <!-- Filtros -->
        <div class="filter-bar">
            <div>
                <label>Produtor</label>
                <select class="form-select" [(ngModel)]="filtroProdutorId" style="min-width:180px;">
                    <option value="">Todos os produtores</option>
                    <option *ngFor="let p of todosProdutores" [value]="p.id">{{ p.nome }}</option>
                </select>
            </div>
            <div>
                <label>Cliente</label>
                <select class="form-select" [(ngModel)]="filtroProdutorClienteId" style="min-width:180px;">
                    <option value="">Todos os clientes</option>
                    <option *ngFor="let c of todosClientes" [value]="c.id">{{ c.nome }}</option>
                </select>
            </div>
            <div>
                <label>Contrato</label>
                <select class="form-select" [(ngModel)]="filtroProdutorContratoId" style="min-width:180px;">
                    <option value="">Todos os contratos</option>
                    <option *ngFor="let c of contratosPorClienteProdutor" [value]="c.id">{{ c.numeroContrato }}</option>
                </select>
            </div>
            <div>
                <label>De</label>
                <input type="date" class="form-control" [(ngModel)]="filtroProdutorPeriodoInicio">
            </div>
            <div>
                <label>At√©</label>
                <input type="date" class="form-control" [(ngModel)]="filtroProdutorPeriodoFim">
            </div>
            <div class="ms-auto">
                <button class="btn btn-outline-secondary btn-sm" (click)="limparFiltrosProdutor()">
                    <i class="bi bi-x-circle me-1"></i> Limpar
                </button>
            </div>
        </div>

        <!-- KPIs Produtor -->
        <div class="kpi-row">
            <div class="kpi-card" style="--kpi-color:#2563eb">
                <div class="kpi-label">Total Sacas</div>
                <div class="kpi-value blue">{{ balancoProdutor_Totais.sacas | number:'1.0-1' }} sc</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#c9a84c">
                <div class="kpi-label">Total KG Entregue</div>
                <div class="kpi-value gold">{{ balancoProdutor_Totais.kg | number:'1.0-0' }} kg</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#dc2626">
                <div class="kpi-label">Total Compra (custo)</div>
                <div class="kpi-value red">{{ balancoProdutor_Totais.compra | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
            <div class="kpi-card" style="--kpi-color:#94a3b8">
                <div class="kpi-label">Produtores Ativos</div>
                <div class="kpi-value">{{ balancoProdutor.length }}</div>
            </div>
        </div>

        <!-- Tabela Produtor -->
        <div class="report-card">
            <div class="report-card-header">
                <div class="report-card-title"><i class="bi bi-person-badge-fill"></i> Volume por Produtor (Origem)
                </div>
                <span class="badge bg-light text-dark">{{ balancoProdutor.length }} produtor(es)</span>
            </div>
            <div *ngIf="balancoProdutor.length === 0" class="empty-state">
                <i class="bi bi-person-badge"></i> Nenhum resultado para os filtros aplicados.
            </div>
            <table *ngIf="balancoProdutor.length > 0" class="report-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Produtor</th>
                        <th class="text-end">Movimenta√ß√µes</th>
                        <th class="text-end">Sacas</th>
                        <th class="text-end">KG Entregue</th>
                        <th class="text-end">Custo Total Compra</th>
                        <th style="width:140px">Volume (%)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let p of balancoProdutor; let i = index">
                        <td>
                            <span class="rank-badge"
                                [ngClass]="i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other'">
                                {{ i + 1 }}
                            </span>
                        </td>
                        <td><strong>{{ p.produtorNome }}</strong></td>
                        <td class="text-end">{{ p.numMovimentacoes }}</td>
                        <td class="text-end">{{ p.totalSacas | number:'1.0-1' }}</td>
                        <td class="text-end">{{ p.totalKg | number:'1.0-0' }} kg</td>
                        <td class="text-end text-danger fw-bold">{{ p.totalCompra | currency:'BRL':'symbol':'1.2-2' }}
                        </td>
                        <td>
                            <div class="small text-muted mb-1">{{ balancoProdutor_Totais.kg > 0 ? ((p.totalKg /
                                balancoProdutor_Totais.kg) * 100 | number:'1.1-1') : 0 }}%</div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill"
                                    [style.width.%]="balancoProdutor_Totais.kg > 0 ? (p.totalKg / balancoProdutor_Totais.kg) * 100 : 0">
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">TOTAL</td>
                        <td class="text-end">{{ balancoProdutor_Totais.sacas | number:'1.0-1' }}</td>
                        <td class="text-end">{{ balancoProdutor_Totais.kg | number:'1.0-0' }} kg</td>
                        <td class="text-end">{{ balancoProdutor_Totais.compra | currency:'BRL':'symbol':'1.2-2' }}</td>
                        <td>100%</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>