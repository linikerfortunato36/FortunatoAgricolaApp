<div class="container-fluid">
    <!-- Alert de sucesso -->
    <div *ngIf="submitSuccess" class="alert alert-success alert-dismissible d-flex align-items-center mb-4 shadow-sm"
        role="alert">
        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
        <div>
            <strong>Movimentação registrada com sucesso!</strong><br>
            <small>O saldo do contrato foi atualizado. Redirecionando ao painel...</small>
        </div>
    </div>

    <!-- Alert de erro -->
    <div *ngIf="submitError" class="alert alert-danger alert-dismissible d-flex align-items-center mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
        <div>{{ submitError }}</div>
        <button type="button" class="btn-close" (click)="submitError = ''"></button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a routerLink="/app/contratos"
                            class="text-decoration-none">Contratos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Nova Movimentação / Balança</li>
                </ol>
            </nav>
            <h2 class="h3 fw-bold text-dark mb-0">Registrar Movimentação (Ticket de Balança)</h2>
        </div>
        <div>
            <button type="button" (click)="cancelar()" class="btn btn-outline-secondary me-2">
                <i class="bi bi-x-circle me-1"></i> Cancelar
            </button>
            <button type="button" (click)="onSubmit()" class="btn btn-primary fw-bold"
                [disabled]="isSubmitting || submitSuccess">
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status"></span>
                <i *ngIf="!isSubmitting" class="bi bi-floppy me-1"></i>
                {{ isSubmitting ? 'Salvando...' : 'Confirmar Movimentação' }}
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-9">

            <!-- CARD 1: Identificação da Viagem -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom pt-3 pb-2 d-flex align-items-center">
                    <i class="bi bi-truck text-primary fs-5 me-2"></i>
                    <h5 class="fw-bold mb-0 text-primary">Dados da Viagem e Origem</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-dark small">Data da Movimentação *</label>
                            <input type="date" class="form-control" [(ngModel)]="form.data" required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold text-dark small">Contrato Vinculado *</label>
                            <ng-select [items]="contratos" bindLabel="numeroContrato" bindValue="id"
                                [(ngModel)]="form.contratoId" placeholder="Selecione o contrato..." [clearable]="false">
                                <ng-template ng-option-tmp let-item="item">
                                    {{ item.numeroContrato }} — {{ item.clienteNome }}
                                    <small class="d-block text-muted">Saldo: {{ (item.quantidadeRestanteKg / 1000) |
                                        number:'1.0-0' }}t</small>
                                </ng-template>
                            </ng-select>
                            <div *ngIf="contratoSelecionado" class="form-text text-success">
                                <i class="bi bi-check-circle me-1"></i> Saldo disponível:
                                <strong>{{ (contratoSelecionado.quantidadeRestanteKg / 1000) | number:'1.0-2' }}
                                    t</strong>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <label class="form-label fw-bold text-dark small">Produtor / Fazenda Origem *</label>
                            <ng-select [items]="produtores" bindLabel="nome" bindValue="id"
                                [(ngModel)]="form.produtorOrigemId" placeholder="Selecione o produtor..."
                                [clearable]="false">
                            </ng-select>
                        </div>

                        <div class="col-md-5">
                            <label class="form-label fw-bold text-dark small">Transportadora *</label>
                            <ng-select [items]="transportadoras" bindLabel="nome" bindValue="id"
                                [(ngModel)]="form.transportadoraId" placeholder="Selecione a transportadora..."
                                [clearable]="false">
                            </ng-select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold text-dark small">Nome do Motorista</label>
                            <input type="text" class="form-control" [(ngModel)]="form.motorista"
                                placeholder="José Carlos">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold text-dark small">Vendedor (Usuário) *</label>
                            <ng-select [items]="vendedores" bindLabel="nome" bindValue="id"
                                [(ngModel)]="form.vendedorId" placeholder="Selecione o vendedor...">
                            </ng-select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 2: Pesagem e Descontos -->
            <div class="card shadow-sm border-0 mb-4 bg-light">
                <div class="card-header bg-white border-bottom pt-3 pb-2 d-flex align-items-center">
                    <i class="bi bi-speedometer fs-5 me-2 text-dark"></i>
                    <h5 class="fw-bold mb-0 text-dark">Pesagem — Volumes e Descontos Técnicos</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-primary small">Peso Bruto / Origem (Kg) *</label>
                            <input type="number" class="form-control bg-white text-end fw-bold"
                                [(ngModel)]="form.quantidadeOrigemKg" placeholder="0" min="0">
                            <div class="form-text">Pesagem na fazenda / carregamento.</div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold text-success small">Peso Líquido Fazenda (Kg)</label>
                            <input type="number" class="form-control bg-white text-end fw-bold"
                                [(ngModel)]="form.pesoLiquidofazenda" placeholder="0" min="0">
                            <div class="form-text">Peso líquido descontado na origem.</div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold text-primary small">Peso Descarga / Destino (Kg) *</label>
                            <input type="number" class="form-control bg-white text-end fw-bold"
                                [(ngModel)]="form.pesoDescargaKg" (ngModelChange)="calcularDescontos()" placeholder="0"
                                min="0">
                            <div class="form-text">Pesagem no terminal / armazém.</div>
                        </div>

                        <div class="col-md-4 d-flex align-items-center pt-4">
                            <div *ngIf="diferencaPeso > 0"
                                class="text-danger small fw-bold bg-danger bg-opacity-10 p-2 rounded w-100 text-center">
                                <i class="bi bi-arrow-down-circle me-1"></i>
                                Quebra: <strong>{{ diferencaPeso | number:'1.0-0' }} Kg</strong>
                                ({{ (diferencaPeso / form.quantidadeOrigemKg * 100) | number:'1.1-1' }}%)
                            </div>
                        </div>

                        <div class="col-12">
                            <hr class="opacity-10 border-dark my-0">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold text-danger small">Umidade Aferida (%)</label>
                            <input type="number" class="form-control text-center" [(ngModel)]="form.umidadePorcentagem"
                                (ngModelChange)="calcularDescontos()" step="0.1" min="0" max="30">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold text-danger small">Desconto Umidade (Kg)</label>
                            <input type="number" class="form-control text-end text-danger fw-bold bg-white"
                                [(ngModel)]="form.umidadeKg" step="0.01" min="0">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold small" style="color: #a05c00;">Impureza Aferida (%)</label>
                            <input type="number" class="form-control text-center" [(ngModel)]="form.impurezaPorcentagem"
                                (ngModelChange)="calcularDescontos()" step="0.1" min="0" max="10">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold small" style="color: #a05c00;">Desconto Impureza
                                (Kg)</label>
                            <input type="number" class="form-control text-end fw-bold bg-white"
                                [(ngModel)]="form.impurezaKg" step="0.01" min="0">
                        </div>
                    </div>
                </div>

                <!-- Peso Final Calculado -->
                <div class="card-footer border-0 rounded-bottom p-0">
                    <div class="p-3 text-white d-flex justify-content-between align-items-center"
                        style="background-color: var(--primary-color, #1a4a1a);">
                        <div>
                            <span class="text-uppercase opacity-75 small fw-bold d-block">Peso Final Oficial
                                (Cálculo)</span>
                            <small class="opacity-50">Descarga − Umidade − Impureza</small>
                        </div>
                        <div class="text-end">
                            <span class="fs-2 fw-bolder"
                                [ngClass]="pesoFinalCalculado > 0 ? 'text-warning' : 'text-danger'">
                                {{ pesoFinalCalculado | number:'1.0-0' }} <small class="fs-5">Kg</small>
                            </span>
                            <div class="small opacity-75">≈ {{ (pesoFinalCalculado / 60) | number:'1.0-1' }} sacas</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- SIDEBAR direita -->
        <div class="col-xl-3">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="fw-bold text-dark mb-3"><i class="bi bi-info-circle-fill text-primary me-2"></i>Resumo
                        Rápido</h6>

                    <div class="d-flex justify-content-between mb-2 small">
                        <span class="text-muted">Contrato:</span>
                        <strong class="text-end" style="max-width: 60%;">{{ contratoSelecionado?.numeroContrato || '—'
                            }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small">
                        <span class="text-muted">Cliente:</span>
                        <strong class="text-end" style="max-width: 60%;">{{ contratoSelecionado?.clienteNome || '—'
                            }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small">
                        <span class="text-muted">Peso Origem:</span>
                        <strong>{{ form.quantidadeOrigemKg | number:'1.0-0' }} Kg</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small">
                        <span class="text-muted">Peso Descarga:</span>
                        <strong>{{ form.pesoDescargaKg | number:'1.0-0' }} Kg</strong>
                    </div>
                    <hr class="opacity-25">
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted fw-bold">Peso Final:</span>
                        <strong class="text-primary fs-6">{{ pesoFinalCalculado | number:'1.0-0' }} Kg</strong>
                    </div>
                    <div class="d-flex justify-content-between small mt-1">
                        <span class="text-muted fw-bold">Sacas:</span>
                        <strong class="text-primary">{{ (pesoFinalCalculado / 60) | number:'1.0-1' }} sc</strong>
                    </div>
                </div>
            </div>

            <div class="card bg-warning bg-opacity-10 border-warning shadow-sm">
                <div class="card-body p-3">
                    <h6 class="fw-bold text-dark small"><i class="bi bi-lightning-fill text-warning me-1"></i>Cálculo
                        Automático</h6>
                    <p class="small text-muted mb-0">Ao informar o <strong>Peso de Descarga</strong> e as porcentagens
                        de <strong>Umidade</strong> e <strong>Impureza</strong>, os descontos em Kg são calculados
                        automaticamente.</p>
                </div>
            </div>
        </div>
    </div>
</div>