<div class="container-fluid">
    <!-- Feedback Alerts -->
    <div *ngIf="submitSuccess"
        class="alert alert-success alert-dismissible d-flex align-items-center mb-4 shadow-sm animate__animated animate__fadeInDown"
        role="alert">
        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
        <div>
            <strong>Movimentação registrada com sucesso!</strong><br>
            <small>Os saldos e ganhos foram processados. Redirecionando...</small>
        </div>
    </div>

    <div *ngIf="submitError" class="alert alert-danger alert-dismissible d-flex align-items-center mb-4 shadow-sm"
        role="alert">
        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
        <div>{{ submitError }}</div>
        <button type="button" class="btn-close" (click)="submitError = ''"></button>
    </div>

    <!-- Header Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a routerLink="/app/contratos"
                            class="text-decoration-none">Contratos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Nova Movimentação (Ticket de Balança)</li>
                </ol>
            </nav>
            <h2 class="h3 fw-bold text-dark mb-0">Registrar Movimentação de Grãos</h2>
        </div>
        <div>
            <button type="button" (click)="cancelar()" class="btn btn-outline-secondary me-2">
                <i class="bi bi-x-circle me-1"></i> Cancelar
            </button>
            <button type="button" (click)="onSubmit()" class="btn btn-primary fw-bold"
                [disabled]="isSubmitting || submitSuccess">
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                <i *ngIf="!isSubmitting" class="bi bi-floppy me-1"></i> Salvar Registro
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-9">

            <!-- SEÇÃO 1: IDENTIFICAÇÃO E ORIGEM -->
            <div class="card shadow-sm border-0 mb-4 overflow-hidden">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0 text-primary"><i class="bi bi-truck me-2"></i>Identificação da Viagem e
                        Origem</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold small">Data do Ticket *</label>
                            <input type="date" class="form-control" [(ngModel)]="form.data" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Contrato / Cliente *</label>
                            <ng-select [items]="contratos" bindLabel="numeroContrato" bindValue="id"
                                [(ngModel)]="form.contratoId" placeholder="Selecione o contrato...">
                                <ng-template ng-option-tmp let-item="item">
                                    {{ item.numeroContrato }} — {{ item.clienteNome }}
                                    <small class="d-block text-muted">Saldo restante: {{ item.quantidadeRestanteKg |
                                        number }} kg</small>
                                </ng-template>
                            </ng-select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold small">Produtor (Origem) *</label>
                            <ng-select [items]="produtores" bindLabel="nome" bindValue="id"
                                [(ngModel)]="form.produtorOrigemId"
                                placeholder="Selecione o produtor origem..."></ng-select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Transportadora *</label>
                            <ng-select [items]="transportadoras" bindLabel="nome" bindValue="id"
                                [(ngModel)]="form.transportadoraId"
                                placeholder="Selecione a transportadora..."></ng-select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Nome do Motorista</label>
                            <input type="text" class="form-control" [(ngModel)]="form.motorista"
                                placeholder="Nome completo do condutor">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Vendedor (Usuário) *</label>
                            <ng-select [items]="vendedores" bindLabel="nome" bindValue="id"
                                [(ngModel)]="form.vendedorId" placeholder="Vendedor responsável..."></ng-select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 2: VOLUMETRIA E TÉCNICO -->
            <div class="card shadow-sm border-0 mb-4 bg-light bg-opacity-50">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0 text-dark"><i class="bi bi-speedometer2 me-2"></i>Volumes de Balança e
                        Descontos Técnicos</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4 mb-4 border-bottom pb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Peso Bruto na Origem (Kg) *</label>
                            <input type="number" class="form-control form-control-lg text-end fw-bold"
                                [(ngModel)]="form.quantidadeOrigemKg" placeholder="0">
                            <div class="form-text">Resultará em <strong>{{ sacas | number:'1.0-1' }} sacas</strong>.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-success">Peso Líquido Fazenda (Kg)</label>
                            <input type="number" class="form-control form-control-lg text-end"
                                [(ngModel)]="form.pesoLiquidofazenda" placeholder="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-primary">Peso de Descarga / Destino (Kg) *</label>
                            <input type="number" class="form-control form-control-lg text-end fw-bold"
                                [(ngModel)]="form.pesoDescargaKg" (ngModelChange)="calcularDescontos()" placeholder="0">
                            <div *ngIf="diferencaPeso > 0" class="form-text text-danger fw-bold">Quebra total de {{
                                diferencaPeso | number }} Kg.</div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">Umidade (%)</label>
                            <input type="number" class="form-control text-center" [(ngModel)]="form.umidadePorcentagem"
                                (ngModelChange)="calcularDescontos()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">Umidade (Kg)</label>
                            <input type="number" class="form-control text-end" [(ngModel)]="form.umidadeKg">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">Impureza (%)</label>
                            <input type="number" class="form-control text-center" [(ngModel)]="form.impurezaPorcentagem"
                                (ngModelChange)="calcularDescontos()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">Impureza (Kg)</label>
                            <input type="number" class="form-control text-end" [(ngModel)]="form.impurezaKg">
                        </div>
                    </div>
                </div>
                <div
                    class="card-footer bg-white border-0 py-3 text-end d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-muted">PESO FINAL CALCULADO (COM DESCONTOS):</span>
                    <span class="fs-4 fw-bold text-primary">{{ pesoFinal | number:'1.0-0' }} Kg</span>
                </div>
            </div>

            <!-- SEÇÃO 3: FINANCEIRO E NF-E -->
            <div class="card shadow-sm border-0 mb-4 border-top border-4 border-warning">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0 text-dark"><i class="bi bi-cash-stack me-2"></i>Dados Financeiros e
                        Faturamento</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Número da NF-e</label>
                            <input type="text" class="form-control" [(ngModel)]="form.nfe"
                                placeholder="Nº da Nota Fiscal">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Valor da NF-e (R$)</label>
                            <input type="number" class="form-control text-end" [(ngModel)]="form.valorNfe"
                                placeholder="0,00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Venda por Saca (R$)</label>
                            <input type="number" class="form-control text-end fw-bold text-success"
                                [(ngModel)]="form.valorVendaPorSaca" placeholder="0,00">
                        </div>

                        <div class="col-md-3 mt-4">
                            <label class="form-label fw-bold small">Compra por Saca (R$)</label>
                            <input type="number" class="form-control text-end" [(ngModel)]="form.valorCompraPorSaca"
                                placeholder="0,00">
                        </div>
                        <div class="col-md-3 mt-4">
                            <label class="form-label fw-bold small">Frete por Saca (R$)</label>
                            <input type="number" class="form-control text-end" [(ngModel)]="form.custoFretePorSaca"
                                placeholder="0,00">
                        </div>
                        <div class="col-md-3 mt-4">
                            <label class="form-label fw-bold small">Armazém por Saca (R$)</label>
                            <input type="number" class="form-control text-end" [(ngModel)]="form.valorPorSacaArmazem"
                                placeholder="0,00">
                        </div>
                        <div class="col-md-3 mt-4">
                            <label class="form-label fw-bold small">Quem paga Armazém?</label>
                            <select class="form-select" [(ngModel)]="form.quemPagaArmazem">
                                <option value="Nos">Nós</option>
                                <option value="Cliente">Cliente</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <h6 class="fw-bold mt-4 mb-3 border-bottom pb-2 text-muted">Datas e Observações</h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Data Prevista de Pgto.</label>
                            <input type="date" class="form-control" [(ngModel)]="form.dataPrevistaPagamento">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Data de Entrega</label>
                            <input type="date" class="form-control" [(ngModel)]="form.dataEntrega">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Observação Geral</label>
                            <textarea class="form-control" rows="1" [(ngModel)]="form.observacao"
                                placeholder="Informações adicionais..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR RESUMO COM CÁLCULOS AUTOMÁTICOS -->
        <div class="col-xl-3 sticky-top" style="top: 1rem;">
            <div class="card shadow-sm border-0 bg-dark text-white rounded-4 overflow-hidden mb-4">
                <div class="card-header bg-primary border-0 py-3">
                    <h6 class="fw-bold mb-0 text-white"><i class="bi bi-calculator me-2"></i>Resumo do Ganho</h6>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between mb-3">
                        <span class="opacity-75">Venda Bruta:</span>
                        <span class="fw-bold">R$ {{ valorTotalVenda | number:'1.2-2' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="opacity-75">Total da Compra:</span>
                        <span class="text-danger fw-bold">- R$ {{ totalCompra | number:'1.2-2' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4 border-bottom border-secondary pb-3">
                        <span class="opacity-75">Ganho Bruto:</span>
                        <span class="text-warning fw-bold">R$ {{ ganhoBruto | number:'1.2-2' }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2 small text-secondary">
                        <span>Imposto Est. (Saca):</span>
                        <span>- R$ {{ imposto | number:'1.2-2' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4 small text-secondary">
                        <span>Comissão LD:</span>
                        <span>- R$ {{ comissaoLd | number:'1.2-2' }}</span>
                    </div>

                    <div class="mt-4 p-3 bg-white bg-opacity-10 rounded-3">
                        <span class="text-uppercase small fw-bold text-primary d-block mb-1">Ganho Líquido
                            Estimado</span>
                        <h3 class="fw-bold mb-0 text-primary">R$ {{ ganhoLiquido | number:'1.2-2' }}</h3>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4 bg-light">
                <div class="card-body">
                    <h6 class="fw-bold text-dark mb-3 small"><i class="bi bi-info-circle me-1"></i>Regras de Cálculo
                    </h6>
                    <ul class="ps-3 small text-muted">
                        <li class="mb-2"><strong>Total Compra:</strong> (Compra + Frete + Armazém*) × Sacas</li>
                        <li class="mb-2"><strong>Impostos/Comissões:</strong> Baseados na quantidade total de sacas.
                        </li>
                        <li class="mb-2"><strong>Peso Final:</strong> Dedução automática de Umidade e Impureza do peso
                            de descarga.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>