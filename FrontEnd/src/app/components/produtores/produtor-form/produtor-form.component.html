<div class="container-fluid" style="padding-bottom: 50px;">
    <!-- Headings e Nav -->
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <h2 class="h3 fw-bold text-dark pe-3 mb-1" style="display:-webkit-inline-box">
                <button routerLink="/app/produtores" class="btn btn-outline-secondary me-2 btn-sm rounded-circle"><i
                        class="bi bi-arrow-left"></i></button>
                {{ isEditing ? produtor.nome : 'Novo Produtor' }}
            </h2>
            <p class="text-muted mb-0 small" style="margin-left: 2.8rem">Painel gerencial do produtor (fazenda).</p>
        </div>
        <div *ngIf="isEditing">
            <ul class="nav nav-pills bg-light rounded shadow-sm px-2 py-2">
                <li class="nav-item">
                    <button class="nav-link bg-transparent fw-bold rounded-pill mx-1 active"
                        [class.bg-white]="activeTab === 'boards'" [class.text-primary]="activeTab === 'boards'"
                        [class.shadow-sm]="activeTab === 'boards'" [class.text-muted]="activeTab !== 'boards'"
                        (click)="setActiveTab('boards')">
                        <i class="bi bi-clipboard-data"></i> Painel de Entregas
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link bg-transparent fw-bold rounded-pill mx-1"
                        [class.bg-white]="activeTab === 'form'" [class.text-primary]="activeTab === 'form'"
                        [class.shadow-sm]="activeTab === 'form'" [class.text-muted]="activeTab !== 'form'"
                        (click)="setActiveTab('form')">
                        <i class="bi bi-person-lines-fill"></i> Cadastro (Dados)
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Aba Padrão de Form (Quando Novo/Add) -->
    <div *ngIf="activeTab === 'form'">
        <div class="row w-100">
            <div class="col-lg-12">
                <div class="card shadow-sm border-0 mb-4 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                        <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-building"></i> Dados Cadastrais</h6>
                    </div>
                    <div class="card-body">
                        <form (ngSubmit)="onSubmit()" #produtorForm="ngForm">
                            <div class="row g-3">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted small fw-bold">Nome / Razão Social <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="nome" [(ngModel)]="produtor.nome"
                                        required placeholder="Ex: Fazenda Boa Vista Silva">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label text-muted small fw-bold">CPF / CNPJ <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="cpfCnpj"
                                        [(ngModel)]="produtor.cpfCnpj" required placeholder="000.000.000-00">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label text-muted small fw-bold">Inscrição Estadual</label>
                                    <input type="text" class="form-control" name="inscricaoEstadual"
                                        [(ngModel)]="produtor.inscricaoEstadual" placeholder="Isento pu N.º">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label text-muted small fw-bold">Telefone</label>
                                    <input type="text" class="form-control" name="telefone"
                                        [(ngModel)]="produtor.telefone" placeholder="(00) 00000-0000">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label text-muted small fw-bold">E-mail</label>
                                    <input type="email" class="form-control" name="email" [(ngModel)]="produtor.email"
                                        placeholder="contato@fazenda.com">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label text-muted small fw-bold d-block">Status</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" role="switch"
                                            id="isActiveSwitch" name="isActive" [(ngModel)]="produtor.isActive">
                                        <label class="form-check-label" for="isActiveSwitch">{{ produtor.isActive ?
                                            'Ativo (Aceita recebimentos)' : 'Inativo (Bloqueado p/ contratos)'
                                            }}</label>
                                    </div>
                                </div>
                            </div>

                            <hr class="text-muted opacity-25 my-4">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-outline-secondary" routerLink="/app/produtores"
                                    [disabled]="submitting">Cancelar</button>
                                <button type="submit"
                                    class="btn btn-primary px-4 fw-bold shadow-sm d-flex align-items-center"
                                    [disabled]="!produtorForm.form.valid || submitting">
                                    <i class="bi bi-floppy me-2 d-none d-sm-inline"></i>
                                    <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
                                    Salvar Produtor
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba de Painel de Entregas / Recebimento de Cargas do Produtor -->
    <div *ngIf="activeTab === 'boards'">
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-5">
            <div class="col" *ngFor="let summary of contratosGrouped">
                <div class="card border-0 shadow-sm h-100 rounded-4">
                    <div class="card-body p-4 position-relative overflow-hidden">
                        <div class="position-absolute top-0 end-0 bg-primary bg-opacity-10 rounded-bottom-start p-3">
                            <i class="bi bi-file-earmark-text text-primary fs-3 opacity-50"></i>
                        </div>
                        <h6 class="text-uppercase text-muted fw-bold small mb-3">Contrato #{{ summary.contratoNumero }}
                        </h6>

                        <h3 class="fw-bold text-dark mb-1">{{ (summary.totalEntregueKg || 0) | number:'1.0-0' }} Kg</h3>
                        <p class="text-secondary small mb-4">Total Descarregado (Líquido)</p>

                        <div class="d-flex border-top pt-3 gap-3">
                            <div class="flex-fill border-end pe-2">
                                <div class="text-muted small">Cargas Entregues</div>
                                <div class="fw-bold">{{ summary.totalDescargas }} cargas</div>
                            </div>
                            <div class="flex-fill ps-2">
                                <div class="text-muted small">Total em Sacas</div>
                                <div class="fw-bold">{{ (summary.totalSacas || 0) | number:'1.0-0' }} scs</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12" *ngIf="contratosGrouped.length === 0">
                <div class="alert alert-secondary text-center rounded-4 border-0 p-4 w-100 shadow-sm">
                    <i class="bi bi-info-circle fs-3 text-muted d-block mb-2"></i>
                    Nenhuma entrega ou contrato localizado para este produtor.
                </div>
            </div>
        </div>

        <h4 class="mb-3 fw-bold text-dark"><i class="bi bi-list-check me-2 text-primary"></i> Relatórios de Cargas
            (Movimentações)</h4>
        <div class="card shadow-sm border-0 mb-5 rounded-4 overflow-hidden">
            <div class="card-header bg-white border-bottom p-4">
                <div class="row align-items-center">
                    <div class="col-md-6 col-lg-4">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-filter"></i></span>
                            <input type="text" class="form-control bg-light border-start-0 ps-0"
                                placeholder="Filtrar por Contrato..." [(ngModel)]="filtroContrato">
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-nowrap">
                    <thead class="table-light text-muted x-small">
                        <tr>
                            <th class="ps-4">DATA</th>
                            <th>CONTRATO</th>
                            <th>MOTORISTA</th>
                            <th>PESO FAZENDA</th>
                            <th>UMIDADE (KG/%)</th>
                            <th>IMPUREZA (KG/%)</th>
                            <th class="fw-bold text-primary pe-4">PESO LÍQ. DESC.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let m of movimentacoesFiltradas">
                            <td class="ps-4">{{ m.data | date:'dd/MM/yyyy' }}</td>
                            <td><span class="badge bg-secondary bg-opacity-10 text-dark">{{ m.contratoNumero }}</span>
                            </td>
                            <td><i class="bi bi-truck me-1"></i> {{ m.motorista }} <br><span
                                    class="x-small text-muted">{{ m.nfe }}</span></td>
                            <td>{{ m.quantidadeOrigemKg | number:'1.0-0' }} Kg</td>
                            <td>{{ m.umidadeKg | number:'1.0-2' }} Kg <br><span class="text-danger x-small">({{
                                    m.umidadePorcentagem | number:'1.0-2' }}%)</span></td>
                            <td>{{ m.impurezaKg | number:'1.0-2' }} Kg <br><span class="text-danger x-small">({{
                                    m.impurezaPorcentagem | number:'1.0-2' }}%)</span></td>
                            <td class="pe-4 fw-bold text-dark">{{ m.pesoFinal | number:'1.0-0' }} Kg</td>
                        </tr>
                        <tr *ngIf="movimentacoesFiltradas.length === 0">
                            <td colspan="7" class="text-center py-4 text-muted border-bottom-0">Nenhum registro
                                encontrado.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>